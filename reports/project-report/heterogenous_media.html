<!DOCTYPE html
    PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="images/favicon.ico" />

    <title>Computer Graphics - Final Project</title>

    <link href="resources/bootstrap.min.css" rel="stylesheet">
    <link href="resources/offcanvas.css" rel="stylesheet">
    <link href="resources/twentytwenty.css" rel="stylesheet" type="text/css" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
    <nav class="navbar bg-dark navbar-expand-lg navbar-dark fixed-top">
        <a class="navbar-brand" href="enori.html">ENori</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarContent"
            aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div id="navbarContent" class="collapse navbar-collapse">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="enori.html">ENori</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMatthias" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Matthias
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMatthias">
                        <a class="dropdown-item" href="adaptive.html">Adaptive Sampling</a>
                        <a class="dropdown-item" href="disney.html">Disney BSDF</a>
                        <a class="dropdown-item" href="envmap.html">Environment Map Emitter</a>
<a class="dropdown-item" href="emitters.html">Extra Emitter</a>
                        <a class="dropdown-item" href="images.html">Images as Textures</a>
                        <a class="dropdown-item" href="denoising.html">Simple Denoising</a>
                    </div>
                </li>
                <li class="nav-item dropdown active">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownRoger" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Roger
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdownRoger">
                        <a class="dropdown-item" href="anisotropic.html">Anisotropic Phase Function</a>
                        <a class="dropdown-item" href="blender.html">Blender</a>
                        <a class="dropdown-item" href="dof.html">Depth of Field</a>
                        <a class="dropdown-item" href="emissive_medium.html">Emissive Participating Media</a>
                        <a class="dropdown-item active" href="heterogenous_media.html">Hetergoenous Participating Media</a>
                        <a class="dropdown-item" href="normals.html">Normal Mapping</a>
                        <a class="dropdown-item" href="misc-roger.html">Misc</a>
                    </div>
                </li>
            </ul>
        </div>
    </nav>
    <div class="container headerBar">
        <h1>Heterogenous Participating Media (Roger, 30pt)</h1>
    </div>

    <div class="container contentWrapper">
        <div class="pageContent">
            <h4>Media</h4>
            For this feature I added a medium base class, which can be attached to a shape and has a phase function.
            The medium allows for sampling of the free path length and the transmittance per color channel (the free path pdf).
            
            I started with the simpler homogeneous medium and isotropic phase. 
            We can sample the free path length and its pdf (transmittance) from a medium by using the analytic formulas from the slides. 
            The transmittance supports colors and the free path chooses a uniformly random color channel to sample from. <br/><br/>

            The heterogeneous medium uses delta tracking to step along the ray using the maximum density. 
            The delta tracking is used to sample a collision point and to determine the transmittance of the ray. <br/><br/>

            For the heterogeneous volume density sampling I used the NanoVDB datastructure. This allows me to use the bake fluid/smoke simulation directly from blender. 
            As blender exports .vdb files, there is a conversion done to .nvdb files. This effectively creates the .nvdb file as a cache, so we can easily update the vdb file from blender.
            The vdb volume is like a texture that we can evaluate it at a certain coordinate. There is a density and a temperature channel (for emissive media).
            The NanoVDB sampler allows for setting an interpolation order, which improves the visual fidelity.<br/><br/>

            The maximum density for delta tracking can be easily calculated pre-render-time from the NanoVDB grid.
            In the delta tracking process, a complicated part was to convert the rays into the local index space of the NanoVDB grid.<br/><br/>
            
            Currently, the sampling of the NanoVDB grid causes a segmentation fault as the accessor for the sampler is invalidated. 
            
            <br/> <br/>
            <h4>Integrators</h4>
            Now that the we have media to query, I implemented the integrators. First the path_vol_mats integrator starting with the the path_mats as a basis.
            The first difference is that we store the current medium and factor in transmittance to the throughput when propagating the ray.<br/><br/>
            When a ray enters a shape the active medium is updated in the integrator. When it leaves the medium the scene medium replaces it. The scene medium
            is a vacuum medium by default, with infinite free path. However, an arbitrary medium can be attached to the scene. There are some limitations to
            scene media. They cannot have an emitter and rays that miss the scene currently use the environment map (technically this should be black or equal to the accumulated emission).<br/>

            The second difference is that we need to handle medium interactions when the samples free path length is shorter than the distance to the next surface interaction.
            In this case we sample the medium phase function and adjust the ray direction. <br/><br/>
            
            As a shape can now have one of or both a bsdf and an medium, we need to handle medium interfaces without a surface differently. 
            Notably shadowrays should not be occluded by medium-only interfaces in path_vol_mis and the ray direction should stay constant. <br/><br/>
            
            The path_vol_mats integrator is quite straightforward without emissive media in my opinion and fits in about 100 lines of verbose code. <br/><br/>

            <h4>MIS Integrator</h4>
            To importance sample the media, I implemented the path_vol_mis which is based on the path_mis and path_vol_mats.
            This additionally samples a random emitter and casts a shadow ray, which propagates through media. The `Li` function is quite similar to the path_vol_mats.
            We only have the additional weighting of the Li contribution when hitting an emitter and the call to the sampleEmitter function. An emitter is sampled both
            when hitting a surface and when in a medium interaction.<br/><br/>

            In `sampleEmitter`, we perform similar steps to the path_mis except that the shadowray propagating is offloaded to another function. We need to account for the shadowray transmittance
            as well as querying the correct interaction (bsdf or phase pdf) when calculating the weight.<br/><br/>

            In the `traceShadowray`, we iteratively propagate the ray and accumulate the transmittance whilst updating the current shadowray medium. 
            This is relatively straightforward when viewed in isolation. However, it appears that this part, or the use of its results, is not fully correct, see below.<br/><br/>

            <h4>Misc</h4>
            The vdb structure is a child object of the heterogeneous media and contains a density and temperature grid.

            I used the NanoVDB viewer as a reference.<br/><br/>

            <h4>Cbox without volumes - Comparison to pa4 path integrators</h4>
            <div class="twentytwenty-container">
                <img src="images/volume/cbox_path_mats.png" alt="path_mats" class="img-responsive">
                <img src="images/volume/cbox_path_mis.png" alt="path_mis" class="img-responsive">
                <img src="images/volume/cbox_path_vol_mats.png" alt="path_vol_mats" class="img-responsive">
                <img src="images/volume/cbox_path_vol_mis.png" alt="path_vol_mis" class="img-responsive">
            </div> <br>
            The integrators correctly handle the scenes without media.

            <h4>Cbox homogeneous volume - scenes/project/volume/cbox_val_{mats,mis}.xml</h4>
            <div class="twentytwenty-container">
                <img src="images/volume/cbox_val_mats.png" alt="path_mats" class="img-responsive">
                <img src="images/volume/cbox_val_mis.png" alt="path_mis" class="img-responsive">
                <img src="images/volume/cbox_val_ref.png" alt="Blender" class="img-responsive">
            </div> <br>
            <p>
                Isotropic phase, unit density. 
                MIS media is too birght and shadow is not visible hinting at a weighting issue and problem in the transmittance of 
                `PathVolMISIntegrator::traceShadowray`.
            </p>

            <h4>Implemented in:</h4>
            <ul>
                <li>include/nori/medium.h</li>
                <li>src/media/medium.cpp</li>
                
                <li>src/media/vacuum.cpp</li>
                <li>src/media/homogeneous.cpp</li>
                <li>src/media/heterogeneous.cpp</li>
                
                <li>src/integrators/path_vol_mats.cpp</li>
                <li>src/integrators/path_vol_mis.cpp</li>

                <li>include/nori/NvdbVolume.h</li>
                <li>src/textures/NvdbVolume.cpp</li>
                <li>src/textures/NvdbVolume.vdb.cpp</li>
            </ul>

        </div>
    </div>


    <!-- Bootstrap core JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="resources/bootstrap.min.js"></script>
    <script src="resources/jquery.event.move.js"></script>
    <script src="resources/jquery.twentytwenty.js"></script>


    <script>
        $(window).load(function () { $(".twentytwenty-container").twentytwenty({ default_offset_pct: 0.5 }); });
    </script>

</body>

</html>